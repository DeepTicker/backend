// src/utils/classifyNews.js
const { Pool } = require("pg");

// ðŸ”¹ í‚¤ì›Œë“œ ë¦¬ìŠ¤íŠ¸ë“¤
const stockKeywords = [
    'ì‹¤ì ë°œí‘œ', 'ë§¤ì¶œ', 'ì˜ì—…ì´ìµ', 'ìˆœì´ìµ', 'ì£¼ê°€', 'ê¸‰ë“±', 'ê¸‰ë½',
    'ìžì‚¬ì£¼', 'ë°°ë‹¹', 'IR', 'ì£¼ì´', 'ìƒìž¥', 'ì‹ ê·œìƒìž¥', 'ê³µëª¨ê°€',
    'íˆ¬ìžìœ ì¹˜', 'M&A', 'ì‚¬ì—…ë³´ê³ ì„œ', 'ëŒ€ê·œëª¨ê³„ì•½', 'ì‹ ì œí’ˆ', 'ê³µìž¥ì¦ì„¤',
  ];
  
  const macroKeywords = [
    'ê¸°ì¤€ê¸ˆë¦¬', 'ê¸ˆë¦¬ì¸ìƒ', 'ê¸ˆë¦¬ë™ê²°', 'ì—°ì¤€', 'FED', 'CPI', 'PPI',
    'ì†Œë¹„ìžë¬¼ê°€ì§€ìˆ˜', 'ê³ ìš©ì§€í‘œ', 'ì‹¤ì—…ë¥ ', 'GDP', 'í™˜ìœ¨', 'ì›ë‹¬ëŸ¬',
    'ë‹¬ëŸ¬', 'ì—”í™”', 'ë¬´ì—­ìˆ˜ì§€', 'ìˆ˜ì¶œìž…', 'ê²½ê¸°ì¹¨ì²´', 'ì¸í”Œë ˆì´ì…˜',
    'ìŠ¤íƒœê·¸í”Œë ˆì´ì…˜', 'ë””í”Œë ˆì´ì…˜', 'ë‚˜ìŠ¤ë‹¥', 'S&P500', 'ë‹¤ìš°ì§€ìˆ˜', 'êµ­ì±„ê¸ˆë¦¬', 'WTI',
  ];
  
  const industryKeywords = {
    "ìƒì—…ì„œë¹„ìŠ¤": ["í”„ëžœì°¨ì´ì¦ˆ", "ë Œíƒˆ", "ë°°ì†¡", "ê³ ê°ì„œë¹„ìŠ¤", "B2B", "B2C", "ì¸ë ¥ê´€ë¦¬", "ìœ„íƒìš´ì˜"],
    "ê¸°íƒ€ê¸ˆìœµ": ["ì—¬ì‹ ", "ë¦¬ìŠ¤", "ìºí”¼íƒˆ", "ëŒ€ë¶€ì—…", "ì €ì¶•ì€í–‰", "ì†Œì•¡ëŒ€ì¶œ", "ì‹ ìš©ê³µì—¬", "ê°€ê³„ëŒ€ì¶œ"],
    "ìœ í†µ": ["ìœ í†µ", "ì†Œë§¤", "íŽ¸ì˜ì ", "ë°±í™”ì ", "ì˜¨ë¼ì¸ì‡¼í•‘", "ë¦¬í…Œì¼", "ìœ í†µì±„ë„", "í™ˆì‡¼í•‘"],
    "ë‚´êµ¬ì†Œë¹„ìž¬ë°ì˜ë¥˜": ["íŒ¨ì…˜", "ì˜ë¥˜", "ìŠ¤í¬ì¸ ìš©í’ˆ", "ê°€ì „", "ìƒí™œê°€ì „", "ë¸Œëžœë“œ", "ë””ìžì¸", "ì†Œë¹„ìž¬"],
    "ë¯¸ë””ì–´": ["ë°©ì†¡", "ì½˜í…ì¸ ", "ë“œë¼ë§ˆ", "OTT", "ì˜ˆëŠ¥", "ì˜ìƒì œìž‘", "í”Œëž«í¼ì½˜í…ì¸ ", "ë¯¸ë””ì–´ì‚¬ì—…"],
    "ìš´ì†¡": ["ë¬¼ë¥˜", "ìš´ì†¡", "íƒë°°", "ìš´í•­", "í•­ë¡œ", "í•­ê³µí™”ë¬¼", "í•­ë§Œ", "êµ­ì œë¬¼ë¥˜"],
    "ìŒì‹ë£Œë°ë‹´ë°°": ["ì‹í’ˆ", "ê°€ê³µì‹í’ˆ", "ìŒë£Œ", "ëƒ‰ë™ì‹í’ˆ", "ì‹ìžìž¬", "ìœ ì œí’ˆ", "ê°€ê³µìœ¡", "ë‹´ë°°ì‚°ì—…"],
    "ê±´ì¶•ì†Œìž¬": ["ì‹œë©˜íŠ¸", "ì² ê·¼", "ê±´ìžìž¬", "ì„ìž¬", "íƒ€ì¼", "ë‹¨ì—´ìž¬", "ê±´ì¶•ìžìž¬", "ë ˆë¯¸ì½˜"],
    "ì†Œí”„íŠ¸ì›¨ì–´": ["ì†Œí”„íŠ¸ì›¨ì–´", "í´ë¼ìš°ë“œ", "SaaS", "ERP", "ë³´ì•ˆì†”ë£¨ì…˜", "í”Œëž«í¼", "ì¸ê³µì§€ëŠ¥", "ë¹…ë°ì´í„°"],
    "ì¦ê¶Œ": ["ì¦ê¶Œì‚¬", "ë¸Œë¡œì»¤ë¦¬ì§€", "ë¦¬ì„œì¹˜ì„¼í„°", "íˆ¬ìžìžë¬¸", "ì¦ê¶Œê±°ëž˜", "ì¦ì‹œ", "ì£¼ì‹ì¤‘ê°œ"],
    "ë³´í—˜": ["ë³´í—˜", "ì†í•´ë³´í—˜", "ìƒëª…ë³´í—˜", "ë³´í—˜ê¸ˆ", "ë³´í—˜ë£Œ", "ë³´ìž¥ì„±ë³´í—˜", "ì •ê¸°ë³´í—˜", "ë³´í—˜ì‹œìž¥"],
    "í•˜ë“œì›¨ì–´": ["ì„œë²„", "ìŠ¤í† ë¦¬ì§€", "ê¸°ê¸°", "ë„¤íŠ¸ì›Œí¬ìž¥ë¹„", "ì»´í“¨í„°", "ì „ì‚°ìž¥ë¹„", "ITí•˜ë“œì›¨ì–´"],
    "ì†Œìž¬": ["ì†Œìž¬", "í™”í•™ì†Œìž¬", "ê¸°ì´ˆì†Œìž¬", "ì‹ ì†Œìž¬", "ì²¨ë‹¨ì†Œìž¬", "ì›ìžìž¬", "ê¸°ëŠ¥ì„±ì†Œìž¬"],
    "ìžë³¸ìž¬": ["ì¤‘ìž¥ë¹„", "ì‚°ì—…ê¸°ê³„", "ìƒì‚°ì„¤ë¹„", "ê³µìž¥ìž¥ë¹„", "ì„¤ë¹„íˆ¬ìž", "ê¸°ê³„ìž¥ë¹„", "ì œì¡°ê¸°ê³„"],
    "ê¸ˆì†ë°ê´‘ë¬¼": ["ì² ê°•", "ë¹„ì² ê¸ˆì†", "ê´‘ë¬¼", "êµ¬ë¦¬", "ì•Œë£¨ë¯¸ëŠ„", "ë‹ˆì¼ˆ", "ì›ê´‘", "ì±„êµ´"],
    "ë¶€ë™ì‚°": ["ë¶€ë™ì‚°", "ë¶„ì–‘", "ì•„íŒŒíŠ¸", "ê±´ë¬¼", "ì˜¤í”¼ìŠ¤", "ê³µì‹¤ë¥ ", "ë¶€ë™ì‚°ì‹œìž¥", "ìž„ëŒ€"],
    "ì œì•½ë°ë°”ì´ì˜¤": ["ì œì•½", "ë°”ì´ì˜¤", "ìž„ìƒì‹œí—˜", "ì‹ ì•½", "ì‹ì•½ì²˜", "ë°”ì´ì˜¤ì˜ì•½í’ˆ", "ì¹˜ë£Œì œ", "ë°±ì‹ "],
    "í†µì‹ ì„œë¹„ìŠ¤": ["í†µì‹ ", "5G", "ë°ì´í„°í†µì‹ ", "ë§ì‚¬ìš©ë£Œ", "í†µì‹ ìš”ê¸ˆ", "ìœ ë¬´ì„ ", "ë§ì¤‘ë¦½ì„±", "ë„¤íŠ¸ì›Œí¬"],
    "ìœ í‹¸ë¦¬í‹°": ["ì „ë ¥", "ì—ë„ˆì§€", "ì „ê¸°ìš”ê¸ˆ", "ê°€ìŠ¤ìš”ê¸ˆ", "ì „ë ¥ìˆ˜ìš”", "ê³µê³µìš”ê¸ˆ", "ì „ë ¥ê³µê¸‰"],
    "ì¢…ì´ë°ëª©ìž¬": ["íŽ„í”„", "ì¢…ì´", "ê³¨íŒì§€", "ì œì§€", "ëª©ìž¬", "ëª©ìž¬ê°€ê³µ", "íŒì§€", "ì¸ì‡„ìš©ì§€"],
    "ì€í–‰": ["ì€í–‰", "ì˜ˆëŒ€ë§ˆì§„", "ê¸°ì¤€ê¸ˆë¦¬", "ê¸ˆë¦¬", "ì˜ˆê¸ˆ", "ëŒ€ì¶œ", "ìˆ˜ì‹ ", "ì€í–‰ê¶Œ"],
    "ì˜ë£Œìž¥ë¹„ë°ì„œë¹„ìŠ¤": ["ì˜ë£Œê¸°ê¸°", "ì˜ë£Œìž¥ë¹„", "ì˜ìƒì§„ë‹¨", "ìˆ˜ìˆ ìž¥ë¹„", "ì˜ë£Œì„œë¹„ìŠ¤", "ë³‘ì›ê²½ì˜", "ì§„ë‹¨ê¸°ê¸°"],
    "ì—ë„ˆì§€": ["ì„ìœ ", "ê°€ìŠ¤", "ì „ë ¥", "ìž¬ìƒì—ë„ˆì§€", "íƒœì–‘ê´‘","í’ë ¥", "ë°œì „", "LNG", "ì „ë ¥ë§", "ì „ë ¥ë°œì „"],
    "ìžë™ì°¨ë°ë¶€í’ˆ": ["ìžë™ì°¨", "ì™„ì„±ì°¨", "ì „ê¸°ì°¨", "ë‚´ì—°ê¸°ê´€","ë¶€í’ˆì—…ì²´", "ìžë™ì°¨ë¶€í’ˆ", "ëª¨ë¹Œë¦¬í‹°", "ê³µê¸‰ë§", "ì¹´ë©”ì´ì»¤"],
    "ì†Œë¹„ìžì„œë¹„ìŠ¤": ["í˜¸í…”", "ì—¬í–‰", "ë ˆì €", "ì—”í„°í…Œì¸ë¨¼íŠ¸","êµìœ¡ì„œë¹„ìŠ¤", "í—¬ìŠ¤ì¼€ì–´ì„œë¹„ìŠ¤", "ê³µì—°", "ê´€ê´‘ì‚°ì—…", "ìˆ™ë°•"],
    "ìƒí™œìš©í’ˆ": ["ìƒí™œìš©í’ˆ", "ê°€ì •ìš©í’ˆ", "ìš•ì‹¤ìš©í’ˆ", "ì²­ì†Œìš©í’ˆ","ìœ„ìƒìš©í’ˆ", "íœ´ì§€", "ì„¬ìœ ì œí’ˆ", "ì£¼ë°©ìš©í’ˆ", "í¼ìŠ¤ë„ì¼€ì–´"],
    "ë°˜ë„ì²´": ["ë°˜ë„ì²´", "ë©”ëª¨ë¦¬", "DRAM", "NAND","íŒŒìš´ë“œë¦¬", "ì›¨ì´í¼", "ë¯¸ì„¸ê³µì •", "ë°˜ë„ì²´ìž¥ë¹„", "ë¡œì§ì¹©"],
    "ë””ìŠ¤í”Œë ˆì´": ["ë””ìŠ¤í”Œë ˆì´", "OLED", "LCD", "AMOLED","TFT", "íŒ¨ë„", "ë””ìŠ¤í”Œë ˆì´ìž¥ë¹„", "LED", "í„°ì¹˜ìŠ¤í¬ë¦°"],

};
  
  const themeKeywords = {
    "2ì°¨ì „ì§€": ["2ì°¨ì „ì§€", "ë°°í„°ë¦¬", "ì–‘ê·¹ìž¬", "ìŒê·¹ìž¬", "ì „í•´ì§ˆ", "ì „ê³ ì²´", "ë¦¬íŠ¬ì´ì˜¨", "ë°°í„°ë¦¬íŒ©"],
    "ì „ê¸°ì°¨": ["ì „ê¸°ì°¨", "EV", "ì™„ì†ì¶©ì „", "ê¸‰ì†ì¶©ì „", "ì¶©ì „ì†Œ", "ì „ê¸°ì°¨ë³´ê¸‰", "ì „ê¸°ì°¨ìˆ˜ìš”", "ì „ê¸°ì°¨ì¸í”„ë¼"],
    "AI ì±—ë´‡(ì±—GPT ë“±)": ["AI", "ì±—ë´‡", "ì±—GPT", "ëŒ€í™”í˜• AI", "ìƒì„±í˜•AI", "ì–¸ì–´ëª¨ë¸", "GPTê¸°ë°˜", "í”„ë¡¬í”„íŠ¸ì—”ì§€ë‹ˆì–´ë§"],
    "ì§€ëŠ¥í˜•ë¡œë´‡/ì¸ê³µì§€ëŠ¥(AI)": ["ì§€ëŠ¥í˜•ë¡œë´‡", "AIë¡œë´‡", "ì¸ê³µì§€ëŠ¥", "ìžìœ¨ë¡œë´‡", "ë¡œë´‡ìžë™í™”", "ì‚°ì—…ìš©ë¡œë´‡", "AIê¸°ìˆ "],
    "íë°°í„°ë¦¬": ["íë°°í„°ë¦¬", "ë°°í„°ë¦¬ìž¬í™œìš©", "ë¦¬ì‚¬ì´í´ë§", "ìžì›ìˆœí™˜", "ë¦¬íŠ¬íšŒìˆ˜", "2ì°¨ì „ì§€íšŒìˆ˜"],
    "í´ë¼ìš°ë“œ ì»´í“¨íŒ…": ["í´ë¼ìš°ë“œ", "í´ë¼ìš°ë“œì»´í“¨íŒ…", "í¼ë¸”ë¦­í´ë¼ìš°ë“œ", "IaaS", "PaaS", "SaaS", "ë°ì´í„°ì„¼í„°", "í´ë¼ìš°ë“œì¸í”„ë¼"],
    "ì‹œìŠ¤í…œë°˜ë„ì²´": ["ì‹œìŠ¤í…œë°˜ë„ì²´", "ë¹„ë©”ëª¨ë¦¬", "ë¡œì§ë°˜ë„ì²´", "íŒ¹ë¦¬ìŠ¤", "SoC", "AIë°˜ë„ì²´", "ì„¤ê³„ë°˜ë„ì²´"],
    "HBM(ê³ ëŒ€ì—­í­ë©”ëª¨ë¦¬)": ["HBM", "ê³ ëŒ€ì—­í­ë©”ëª¨ë¦¬", "HBM3", "HBM2e", "ê³ ì†ë©”ëª¨ë¦¬", "AIìš©ë©”ëª¨ë¦¬"],
    "ìžìœ¨ì£¼í–‰ì°¨": ["ìžìœ¨ì£¼í–‰", "ADAS", "ì„¼ì„œìœµí•©", "ë¼ì´ë‹¤", "ë ˆë²¨4", "ìžìœ¨ì°¨", "ìžìœ¨ì£¼í–‰ì‹œìŠ¤í…œ"],
    "í’ë ¥ì—ë„ˆì§€": ["í’ë ¥", "í’ë ¥ë°œì „", "í•´ìƒí’ë ¥", "ìœ¡ìƒí’ë ¥", "í’ë ¥í„°ë¹ˆ", "ìž¬ìƒì—ë„ˆì§€"],
    "íƒœì–‘ê´‘ì—ë„ˆì§€": ["íƒœì–‘ê´‘", "íƒœì–‘ê´‘íŒ¨ë„", "ëª¨ë“ˆíš¨ìœ¨", "íƒœì–‘ì „ì§€", "ìž¬ìƒì—ë„ˆì§€", "ì‹ ìž¬ìƒ"],
    "ì˜¨ì‹¤ê°€ìŠ¤(íƒ„ì†Œë°°ì¶œê¶Œ)/íƒ„ì†Œ í¬ì§‘Â·í™œìš©Â·ì €ìž¥(CCUS)": ["ì˜¨ì‹¤ê°€ìŠ¤", "íƒ„ì†Œë°°ì¶œ", "íƒ„ì†Œë°°ì¶œê¶Œ", "CCUS", "íƒ„ì†Œì¤‘ë¦½", "íƒ„ì†Œê°ì¶•", "íƒ„ì†Œì‹œìž¥"],
    "ë§ˆì´í¬ë¡œë°”ì´ì˜´": ["ë§ˆì´í¬ë¡œë°”ì´ì˜´", "ìž¥ë‚´ë¯¸ìƒë¬¼", "ìœ ìµê· ", "ê· ì´ë¶„ì„", "ë§ˆì´í¬ë¡œí”Œë¡œë¼"],
    "ë©´ì—­í•­ì•”ì œ": ["ë©´ì—­í•­ì•”ì œ", "ë©´ì—­ì„¸í¬ì¹˜ë£Œ", "PD-1", "PD-L1", "í•­ì•”ë©´ì—­ë°˜ì‘", "ì¢…ì–‘ë©´ì—­"],
    "ìœ ì „ìž ì¹˜ë£Œì œ/ë¶„ì„": ["ìœ ì „ìžì¹˜ë£Œ", "ìœ ì „ìžíŽ¸ì§‘", "CRISPR", "ìœ ì „ìžë¶„ì„", "DNAì¹˜ë£Œ", "ìœ ì „ì§ˆí™˜", "ì •ë°€ì˜ë£Œ"],
    "mRNA(ë©”ì‹ ì € ë¦¬ë³´í•µì‚°)": ["mRNA", "ë©”ì‹ ì €RNA", "ë°±ì‹ í”Œëž«í¼", "mRNAê¸°ë°˜ì¹˜ë£Œ", "RNAê¸°ìˆ ", "mRNAë°±ì‹ "],
    "STO(í† í°ì¦ê¶Œ ë°œí–‰)": ["STO", "í† í°ì¦ê¶Œ", "ë””ì§€í„¸ì¦ê¶Œ", "ì¦ê¶Œí† í°", "ìžì‚°í† í°í™”", "ë¶„ì‚°ì›ìž¥", "í† í°ë°œí–‰"],
    "ì¹´ì¹´ì˜¤ë±…í¬(kakao BANK)": ["ì¸í„°ë„·ì€í–‰", "ì¹´ì¹´ì˜¤ë±…í¬", "ë¹„ëŒ€ë©´ê³„ì¢Œ", "ëª¨ë°”ì¼ë±…í‚¹", "ë””ì§€í„¸ë±…í‚¹", "ê°„íŽ¸ì†¡ê¸ˆ", "ì˜ˆì ê¸ˆìƒí’ˆ"],
    "UAM(ë„ì‹¬í•­ê³µëª¨ë¹Œë¦¬í‹°)": ["UAM", "ë„ì‹¬í•­ê³µ", "ì—ì–´íƒì‹œ", "ìˆ˜ì§ì´ì°©ë¥™", "í”Œë¼ìž‰ì¹´", "í•˜ëŠ˜ê¸¸", "ëª¨ë¹Œë¦¬í‹°í˜ì‹ "],
    "ë©”íƒ€ë²„ìŠ¤(Metaverse)": ["ë©”íƒ€ë²„ìŠ¤", "ê°€ìƒí˜„ì‹¤", "VR", "AR", "XR", "ë””ì§€í„¸ì•„ë°”íƒ€", "ë²„ì¶”ì–¼í”Œëž«í¼"]
};

const pool = new Pool({
    user: process.env.DB_USER,
    host: process.env.DB_HOST,
    database: process.env.DB_NAME,
    password: process.env.DB_PASSWORD,
    port: process.env.DB_PORT,
});

async function getAllStockNames() {
    const result = await pool.query("SELECT stock_name FROM tmp_stock");
    return result.rows.map(row => row.stock_name);
}

function countExact(keyword, text) {
    const pattern = new RegExp(`\\b${keyword.replace(/[.*+?^${}()|[\\]\\]/g, '\\$&')}\\b`, 'g');
    return (text.match(pattern) || []).length;
}

function weightedCount(keyword, title, content, titleWeight = 10, contentWeight = 1) {
    return (title.split(keyword).length - 1) * titleWeight + (content.split(keyword).length - 1) * contentWeight;
}

function weightedCountCompany(keyword, title, content, titleWeight = 10, contentWeight = 1) {
    return countExact(keyword, title) * titleWeight + countExact(keyword, content) * contentWeight;
}

async function classifyArticle(title, content, companyList, threshold = 3) {
    const scores = { ê°œë³„ì£¼: 0, ì‚°ì—…êµ°: 0, í…Œë§ˆ: 0, ì „ë°˜ì : 0 };
    const representatives = { ê°œë³„ì£¼: null, ì‚°ì—…êµ°: null, í…Œë§ˆ: null, ì „ë°˜ì : null };

    const stockDetails = [];
    let stockKeywordScore = 0;
    companyList.forEach(name => {
        const score = weightedCountCompany(name, title, content);
        if (score > 0) stockDetails.push({ name, score });
    });
    stockKeywords.forEach(kw => {
        stockKeywordScore += weightedCount(kw, title, content);
    });
    if (stockDetails.length > 0) {
        stockDetails.sort((a, b) => b.score - a.score);
        scores['ê°œë³„ì£¼'] = stockDetails[0].score + stockKeywordScore;
        representatives['ê°œë³„ì£¼'] = stockDetails[0].name;
    } else {
        //scores['ê°œë³„ì£¼'] = stockKeywordScore;
        scores['ê°œë³„ì£¼'] = 0;  //ì£¼ì‹ëª… ì–¸ê¸‰ ì—†ìœ¼ë©´ ê°•ì œë¡œ ì œì™¸ì‹œí‚´
    }

    let bestIndustry = { name: null, score: 0 };
    for (const [industry, keywords] of Object.entries(industryKeywords)) {
        let total = 0;
        keywords.forEach(kw => {
            total += weightedCount(kw, title, content);
        });
        if (total > bestIndustry.score) bestIndustry = { name: industry, score: total };
    }
    scores['ì‚°ì—…êµ°'] = bestIndustry.score;
    representatives['ì‚°ì—…êµ°'] = bestIndustry.name;

    let bestTheme = { name: null, score: 0 };
    for (const [theme, keywords] of Object.entries(themeKeywords)) {
        let total = 0;
        keywords.forEach(kw => {
            total += weightedCount(kw, title, content);
        });
        if (total > bestTheme.score) bestTheme = { name: theme, score: total };
    }
    scores['í…Œë§ˆ'] = bestTheme.score;
    representatives['í…Œë§ˆ'] = bestTheme.name;

    let macroScore = 0;
    macroKeywords.forEach(kw => {
        macroScore += weightedCount(kw, title, content, 20, 10);
    });
    scores['ì „ë°˜ì '] = macroScore;
    representatives['ì „ë°˜ì '] = macroScore > 0 ? 'ê±°ì‹œê²½ì œ' : null;

    const best = Object.entries(scores).sort((a, b) => b[1] - a[1])[0];
    const category = best[1] >= threshold ? best[0] : 'ê·¸ ì™¸';
    const representative = category !== 'ê·¸ ì™¸' ? representatives[category] : null;

    return { category, representative };
}

module.exports = {
    classifyArticle,
    getAllStockNames,
    stockKeywords,
    macroKeywords,
    industryKeywords,
    themeKeywords
};